<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<title>LOBE- SUMMARY TABLE</title>
	<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css"><!--bootstrap file-->
	<link rel="stylesheet" type="text/css" href="css/style.css"><!--Css file-->
	<link rel="stylesheet" type="text/css" href="css/all.min.css"><!--Css file-->
	<link rel="stylesheet" type="text/css" href="css/responsive.css"><!--Css file-->
</head>
<body>
	<section class="dashboard-body">
		<div class="container-fluid">
			<div class="row heading">
				<div class="col-sm-3"></div>
				<div class="col-sm-7">
					<h5>LEARNING OBJECT EVALUATION TOOL</h5>
				</div>
				<div class="col-sm-1 go-bck-btn">
					<a href="javascript:void(0)" id="generate-pdf">Save as PDF</a>
				</div>
				<div class="col-sm-1 go-bck-btn">
					<a href="analytics-panel.html">Go Back</a>
				</div>
			</div>
			<div class="row">
				<!-- Side Panel -->
				<div class="col-sm-3 dashboard-panel">
					<div class="row">
						<div class="col-sm-12">
							<img src="imgs/Ellipse.png">
						</div>
					</div>
					<div class="row">
						<div class="col-sm-12">
							<h4 id="dash-name"></h4>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-12">
							<a href="javascript:void(0)" class="disabled-btn">View Analysis</a>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-12">
							<a href="settings.html">Settings</a>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-12">
							<a href="" id="logout">Logout</a>
						</div>
					</div>
				</div>
				<!-- Main Content body -->
				<div class="col-sm-9 result-panel summary-form-results" id="pdf-html">
					<div class="row new-summary">
						<!-- Summary Table -->
						<h4 style="padding-left:17px">Summary Table</h4>
						<div class="col-sm-12 new-summary-cnt">
							<table class="table table-bordered">
								<thead>
									<thead>
										<tr>
											<th class="checkbox-tb-head">
												<span>SUBJECT</span>
											</th>
											<th class="question-tb">
												<span>Learning Object Name</span>
											</th>
											<th class="cont">
												<span>Content Quality (C)<br/></span>
											</th>
											<th class="ped">
												<span>Pedagogical Alignment (P)<br/></span>
											</th>
											<th class="des">
												<span>Design Efficacy(D)<br/></span>
											</th>
											<th class="tech">
												<span>Technology Intregation (T)<br/> </span>
											</th>
											<th class="aggregate">
												<span>Aggregate CPDT scores<br/></span>
											</th>
										</tr>
									</thead>
									<tbody class="alSc">
										
									</tbody>
								</thead>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
	</section>
</body>
<script type="text/javascript" src="js/jquery-3.2.1.min.js"></script><!--JQuery file-->
<script type="text/javascript" src="js/jquery-ui.min.js"></script><!--Jquery UI File-->
<script type="text/javascript" src="js/umd/popper.min.js"></script><!--popper-->
<script type="text/javascript" src="js/bootstrap.min.js"></script><!--bootstrap-->
<script type="text/javascript" src="js/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.debug.js" integrity="sha384-NaWTHo/8YCBYJ59830LTz/P4aQZK1sS0SneOgAvhsIl3zBu8r9RevNg5lHCHAuQ/" crossorigin="anonymous"></script>

<script type="text/javascript" src="js/auth.js"></script>
<script type="text/javascript">
	$(document).ready(function () {

		var user = runValidations();
		var accessToken = localStorage.getItem("accessToken");

		if(user.status!='ACTIVE'){
			window.location.replace("signup.html");
		}

		var type;
		if(user.roles.includes('evaluator')){
			type='evaluator';
			$('#dash-name').append('EVALUATOR DASHBOARD');
		}
		else{
			type='generator';
			$('#dash-name').append('GENERATOR DASHBOARD');
		}

		var url = new URL(window.location.href);
		var lobeIds = url.searchParams.get("lobeIds");

		$('[data-toggle="tooltip"]').tooltip();

		$.ajax({
			type: 'GET',
			url: basePath+'/api/analytics/lobe-summary?lobeIds='+lobeIds,
			dataType: 'json',
			async: false,
			headers : {
				'Authorization': 'Bearer '+accessToken,
			},
			success: function(response){
				console.log(response);
				var i=0;
				var cTotal=0;
				var pTotal=0;
				var dTotal=0;
				var tTotal=0;
				var hTotal=0;
				var cMax=0;
				var pMax=0;
				var dMax=0;
				var tMax=0;
				var hMax=0;
				html='';
				var totalLobes = 0;
				response.data.forEach(function(lobe){
					totalLobes++;
					if(i==0){
						var maxTotal=0;
						lobe.dimensionAggScores.forEach(function(aggScore){

							var dimName = aggScore.dimensionName;
							var scoreStr = '(Out Of '+aggScore.maxScore+' Marks)';

							maxTotal+=aggScore.maxScore;

							if(dimName=='Content Quality'){
								cMax+=aggScore.maxScore;
								$('.cont span').append(scoreStr);
							}
							else if(dimName=='Pedagogical Alignment'){
								pMax+=aggScore.maxScore;
								$('.ped span').append(scoreStr);
							}
							if(dimName=='Design Efficacy'){
								dMax+=aggScore.maxScore;
								$('.des span').append(scoreStr);
							}
							if(dimName=='Technological Integration'){
								tMax+=aggScore.maxScore;
								$('.tech span').append(scoreStr);
							}

						});
						$('.aggregate span').append('(Out Of '+maxTotal+' Marks)');
						hMax+=maxTotal;
					}
					i++;

					html+='<tr>';
					html+='<th></th>';
					html+='<th><span>'+lobe.learningObjectName+'</span></th>';

					var horizontalTotal=0;

					var cPres=false;
					var pPres=false;
					var dPres=false;
					var tPres=false;

					lobe.dimensionAggScores.forEach(function(aggScore){

						var dimName = aggScore.dimensionName;
						horizontalTotal+=aggScore.scoreObtained;

						if(dimName=='Content Quality'){
							cTotal+=aggScore.scoreObtained;
							cPres=true;
						}
						else if(dimName=='Pedagogical Alignment'){
							pTotal+=aggScore.scoreObtained;
							pPres=true;
							if(!cPres){
								html+='<th></th>';
							}
						}
						else if(dimName=='Design Efficacy'){
							dTotal+=aggScore.scoreObtained;
							dPres=true;
							if(!cPres){
								html+='<th></th>';
							}
							if(!pPres){
								html+='<th></th>';
							}
						}
						else if(dimName=='Technological Integration'){
							tTotal+=aggScore.scoreObtained;
							tPres=true;
							if(!cPres){
								html+='<th></th>';
							}
							if(!pPres){
								html+='<th></th>';
							}
							if(!dPres){
								html+='<th></th>';
							}
						}
						html+='<th><span>'+aggScore.scoreObtained+'</span></th>';
					});
					if(!tPres){
						html+='<th></th>';
						if(!dPres){
							html+='<th></th>';
							if(!pPres){
								html+='<th></th>';
							}
						}
					}
					hTotal+=horizontalTotal;
					html+='<th><span>'+horizontalTotal+'</span></th>';
					html+'</tr>';
				});
				html+='<tr class="average-percentage">';
				html+='<th colspan="2"><span>Average Score</span></th>';
				html+=cMax==0?'<th></th>':'<th><span>'+(cTotal/totalLobes).toFixed(2)+'</span></th>';
				html+=pMax==0?'<th></th>':'<th><span>'+(pTotal/totalLobes).toFixed(2)+'</span></th>';
				html+=dMax==0?'<th></th>':'<th><span>'+(dTotal/totalLobes).toFixed(2)+'</span></th>';
				html+=tMax==0?'<th></th>':'<th><span>'+(tTotal/totalLobes).toFixed(2)+'</span></th>';
				html+='<th><span>'+(hTotal/totalLobes).toFixed(2)+'</span></th>';
				html+='</tr>';

				html+='<tr class="average-percentage">';
				html+='<th colspan="2"><span>Average Percentage</span></th>';
				html+=cMax==0?'<th></th>':'<th><span>'+(cTotal/totalLobes*100/cMax).toFixed(2)+'%</span></th>';
				html+=pMax==0?'<th></th>':'<th><span>'+(pTotal/totalLobes*100/pMax).toFixed(2)+'%</span></th>';
				html+=dMax==0?'<th></th>':'<th><span>'+(dTotal/totalLobes*100/dMax).toFixed(2)+'%</span></th>';
				html+=tMax==0?'<th></th>':'<th><span>'+(tTotal/totalLobes*100/tMax).toFixed(2)+'%</span></th>';
				html+='<th><span>'+(hTotal/totalLobes*100/hMax).toFixed(2)+'%</span></th>';
				html+='</tr>';

				$('.alSc').append(html);
			}
		});

		$('.select-rubric a').click(function () {
			$('.learning-rubric').show();
			$('.select-rubric a').hide();
		});

		$('#generate-pdf').click(function() {

			html2canvas(document.querySelector("#pdf-html")).then(canvas => {

	            try {
		            contentH = $('#pdf-html').height();
		            var img = canvas.toDataURL("image/png", 1.0);
		            $w = $actw = canvas.width;
		            $h = $acth = canvas.height;
		            var pdf = new jsPDF("p", "mm", "a4");
		            var width = $maxw = pdf.internal.pageSize.width;
		            var height = $maxh = pdf.internal.pageSize.height;
		            if (!$maxw) $maxw = width;
		            if (!$maxh) $maxh = height;
		            if ($w > $maxw) {
		                $w = $maxw;
		                $h = Math.round($acth / $actw * $maxw);
		            }
		            pdf.addImage(img, 'JPEG', 0, 0, $w, $h);
		            $count = Math.ceil($h) / Math.ceil($maxh);
		            $count = Math.ceil($count);
		            for (var i = 1; i < $count; i++) {
		                position = - $maxh * i
		                pdf.addPage(img, 'JPEG', 0, 0, $w, $h);
		                pdf.addImage(img, 'JPEG', 0, position, $w, $h);
		            }
		            pdf.save("summary-table.pdf");
		        } catch (e) {
		            alert("Error description: " + e.message);
		        }
			});
		    
		});
	});
</script>
</html>